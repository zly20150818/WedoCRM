-- ==================== ExportCRM ÂÆåÊï¥Êï∞ÊçÆÂ∫ìÂàùÂßãÂåñËÑöÊú¨ ====================
-- Êï¥Âêà‰∫ÜÊâÄÊúâËøÅÁßªÊñá‰ª∂Ôºà001-006Ôºâ
-- Âü∫‰∫éÈáçÊûÑÂêéÁöÑÁî®Êà∑Á≥ªÁªüÔºöÂÆåÂÖ®‰ΩøÁî® auth.users ÁöÑ user_metadata
-- 
-- ËøêË°åÊ≠§ËÑöÊú¨Â∞ÜÂàõÂª∫ÂÆåÊï¥ÁöÑÊï∞ÊçÆÂ∫ìÁªìÊûÑ
-- 
-- üìå ÈáçË¶ÅÔºöÁî®Êà∑‰ø°ÊÅØÂ≠òÂÇ®Âú® auth.users.user_metadata ‰∏≠
-- ‰∏çÂÜç‰ΩøÁî® profiles Ë°®ÔºÅ
--
-- ==================== ÁõÆÂΩï ====================
-- Á¨¨‰∏ÄÈÉ®ÂàÜÔºöÁî®Êà∑Á≥ªÁªüÂíåËæÖÂä©ÂáΩÊï∞
-- Á¨¨‰∫åÈÉ®ÂàÜÔºöÂÆ¢Êà∑ÂíåÁ∫øÁ¥¢ÁÆ°ÁêÜ
-- Á¨¨‰∏âÈÉ®ÂàÜÔºö‰∫ßÂìÅÁÆ°ÁêÜ
-- Á¨¨ÂõõÈÉ®ÂàÜÔºö‰æõÂ∫îÂïÜÁÆ°ÁêÜ
-- Á¨¨‰∫îÈÉ®ÂàÜÔºöÈ°πÁõÆÁÆ°ÁêÜ
-- Á¨¨ÂÖ≠ÈÉ®ÂàÜÔºöÊä•‰ª∑ÁÆ°ÁêÜ
-- Á¨¨‰∏ÉÈÉ®ÂàÜÔºöËÆ¢ÂçïÁÆ°ÁêÜ
-- Á¨¨ÂÖ´ÈÉ®ÂàÜÔºöÊ†∑ÂìÅÁÆ°ÁêÜ
-- Á¨¨‰πùÈÉ®ÂàÜÔºöÂèëÁ•®ÂíåÊîØ‰ªò
-- Á¨¨ÂçÅÈÉ®ÂàÜÔºöÈááË¥≠ËÆ¢Âçï
-- Á¨¨ÂçÅ‰∏ÄÈÉ®ÂàÜÔºöÂÆ°ÊâπÁ≥ªÁªü
-- Á¨¨ÂçÅ‰∫åÈÉ®ÂàÜÔºöÈÄöÁü•Á≥ªÁªü
-- Á¨¨ÂçÅ‰∏âÈÉ®ÂàÜÔºöÂ∑•‰ΩúÊµÅÁ≥ªÁªü
-- Á¨¨ÂçÅÂõõÈÉ®ÂàÜÔºöÁâ©ÊµÅËØ¢‰ª∑ÂíåË¥πÁî®
-- Á¨¨ÂçÅ‰∫îÈÉ®ÂàÜÔºöRFQ ÁÆ°ÁêÜ
-- Á¨¨ÂçÅÂÖ≠ÈÉ®ÂàÜÔºöÈ°πÁõÆÊàêÊú¨ÂíåÂà©Ê∂¶
-- Á¨¨ÂçÅ‰∏ÉÈÉ®ÂàÜÔºöÂºÇÂ∏∏Â§ÑÁêÜ
-- Á¨¨ÂçÅÂÖ´ÈÉ®ÂàÜÔºöÂÖ∂‰ªñ‰∏öÂä°Ë°®
-- Á¨¨ÂçÅ‰πùÈÉ®ÂàÜÔºöÁî®Êà∑ÂíåÁ≥ªÁªüËÆæÁΩÆ
-- Á¨¨‰∫åÂçÅÈÉ®ÂàÜÔºöÂ§ñË¥∏Âü∫Á°ÄÊï∞ÊçÆÈÖçÁΩÆ
-- Á¨¨‰∫åÂçÅ‰∏ÄÈÉ®ÂàÜÔºöÂ≠òÂÇ®Ê°∂ÈÖçÁΩÆ
-- Á¨¨‰∫åÂçÅ‰∫åÈÉ®ÂàÜÔºöËß¶ÂèëÂô®
-- Á¨¨‰∫åÂçÅ‰∏âÈÉ®ÂàÜÔºöRLS Á≠ñÁï•
-- Á¨¨‰∫åÂçÅÂõõÈÉ®ÂàÜÔºöÁ¥¢Âºï

-- ==================== Á¨¨‰∏ÄÈÉ®ÂàÜÔºöÁî®Êà∑Á≥ªÁªüÂíåËæÖÂä©ÂáΩÊï∞ ====================

-- Ê≥®ÊÑèÔºö‰∏çÂÜçÂàõÂª∫ profiles Ë°®ÔºåÁî®Êà∑‰ø°ÊÅØÂÆåÂÖ®Â≠òÂÇ®Âú® auth.users ÁöÑ user_metadata ‰∏≠
-- user_metadata ÁªìÊûÑÔºö
-- {
--   "first_name": "Âº†",
--   "last_name": "‰∏â",
--   "company": "ABCÂÖ¨Âè∏",
--   "role": "User", // User | Admin | Manager
--   "avatar": "https://...",
--   "is_active": true
-- }

-- ÂàõÂª∫ updated_at Ëß¶ÂèëÂô®ÂáΩÊï∞
CREATE OR REPLACE FUNCTION public.handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ÂàõÂª∫ËæÖÂä©ÂáΩÊï∞ÔºöËé∑ÂèñÁî®Êà∑ËßíËâ≤
CREATE OR REPLACE FUNCTION public.get_user_role(user_id UUID)
RETURNS TEXT AS $$
BEGIN
  RETURN (
    SELECT COALESCE(raw_user_meta_data->>'role', 'User')
    FROM auth.users
    WHERE id = user_id
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ÂàõÂª∫ËæÖÂä©ÂáΩÊï∞ÔºöÊ£ÄÊü•Áî®Êà∑ÊòØÂê¶ÊøÄÊ¥ª
CREATE OR REPLACE FUNCTION public.is_user_active(user_id UUID)
RETURNS BOOLEAN AS $$
BEGIN
  RETURN (
    SELECT COALESCE((raw_user_meta_data->>'is_active')::BOOLEAN, true)
    FROM auth.users
    WHERE id = user_id
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ÂàõÂª∫ËæÖÂä©ÂáΩÊï∞ÔºöÊ£ÄÊü•Áî®Êà∑ÊòØÂê¶‰∏∫ÁÆ°ÁêÜÂëò
CREATE OR REPLACE FUNCTION public.is_admin(user_id UUID)
RETURNS BOOLEAN AS $$
BEGIN
  RETURN (
    SELECT COALESCE(raw_user_meta_data->>'role', 'User') = 'Admin'
    FROM auth.users
    WHERE id = user_id
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ÂàõÂª∫ËæÖÂä©ÂáΩÊï∞ÔºöËé∑ÂèñÂΩìÂâçÁî®Êà∑ËßíËâ≤Ôºà‰ΩøÁî® auth.uid()Ôºâ
CREATE OR REPLACE FUNCTION public.current_user_role()
RETURNS TEXT AS $$
BEGIN
  RETURN public.get_user_role(auth.uid());
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ÂàõÂª∫ËæÖÂä©ÂáΩÊï∞ÔºöÊ£ÄÊü•ÂΩìÂâçÁî®Êà∑ÊòØÂê¶‰∏∫ÁÆ°ÁêÜÂëò
CREATE OR REPLACE FUNCTION public.current_user_is_admin()
RETURNS BOOLEAN AS $$
BEGIN
  RETURN public.is_admin(auth.uid());
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ÂàõÂª∫Ëß¶ÂèëÂô®ÂáΩÊï∞ÔºöÂΩìÁî®Êà∑Ê≥®ÂÜåÊó∂ÔºåÁ°Æ‰øù user_metadata ‰∏≠ÊúâÊ≠£Á°ÆÁöÑËßíËâ≤
-- ÁâπÊÆäËßÑÂàôÔºöÁ¨¨‰∏Ä‰∏™Ê≥®ÂÜåÁöÑÁî®Êà∑Ëá™Âä®Êàê‰∏∫ÁÆ°ÁêÜÂëò
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
DECLARE
  user_role TEXT;
  user_count INTEGER;
  updated_metadata JSONB;
BEGIN
  -- Ê£ÄÊü•ÂΩìÂâçÁî®Êà∑Êï∞ÈáèÔºà‰ªé auth.users Ë°®ËÆ°Êï∞Ôºâ
  SELECT COUNT(*) INTO user_count
  FROM auth.users
  WHERE id != NEW.id;
  
  -- Â¶ÇÊûúÊòØÁ¨¨‰∏Ä‰∏™Áî®Êà∑ÔºåËÆæ‰∏∫ AdminÔºåÂê¶Âàô‰∏∫ User
  IF user_count = 0 THEN
    user_role := 'Admin';
  ELSE
    user_role := COALESCE(NEW.raw_user_meta_data->>'role', 'User');
  END IF;

  -- ÊûÑÂª∫ÂÆåÊï¥ÁöÑ user_metadataÔºåÁ°Æ‰øùÊâÄÊúâÂøÖÈúÄÂ≠óÊÆµÈÉΩÂ≠òÂú®
  updated_metadata := jsonb_build_object(
    'first_name', COALESCE(NEW.raw_user_meta_data->>'first_name', ''),
    'last_name', COALESCE(NEW.raw_user_meta_data->>'last_name', ''),
    'company', NEW.raw_user_meta_data->>'company',
    'role', user_role,
    'avatar', NEW.raw_user_meta_data->>'avatar',
    'is_active', COALESCE((NEW.raw_user_meta_data->>'is_active')::BOOLEAN, true)
  );

  -- Êõ¥Êñ∞Áî®Êà∑ÁöÑ raw_user_meta_data
  NEW.raw_user_meta_data := updated_metadata;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ÂàõÂª∫Ëß¶ÂèëÂô®ÔºöÂΩì auth.users Ë°®‰∏≠ÊèíÂÖ•Êñ∞Áî®Êà∑Êó∂Ëß¶Âèë
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  BEFORE INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- ==================== Á¨¨‰∫åÈÉ®ÂàÜÔºöÂÆ¢Êà∑ÂíåÁ∫øÁ¥¢ÁÆ°ÁêÜ ====================

-- ÂàõÂª∫ customers Ë°®ÔºàÂÆ¢Êà∑Ë°®Ôºâ
CREATE TABLE IF NOT EXISTS public.customers (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    customer_number TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    name_cn TEXT,
    type TEXT DEFAULT 'Prospect',
    industry TEXT,
    country TEXT NOT NULL,
    city TEXT,
    address TEXT,
    website TEXT,
    tax_id TEXT,
    rating INTEGER DEFAULT 0,
    credit_limit DECIMAL(15, 2) DEFAULT 0,
    payment_term TEXT DEFAULT 'T/T',
    currency TEXT DEFAULT 'USD',
    primary_contact TEXT,
    email TEXT,
    phone TEXT,
    tags TEXT[] DEFAULT '{}',
    source TEXT DEFAULT 'Other',
    notes TEXT,
    owner_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    created_by UUID REFERENCES auth.users(id) ON DELETE RESTRICT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ customer_contacts Ë°®ÔºàÂÆ¢Êà∑ËÅîÁ≥ª‰∫∫Ë°®Ôºâ
CREATE TABLE IF NOT EXISTS public.customer_contacts (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    customer_id TEXT NOT NULL REFERENCES public.customers(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    position TEXT,
    department TEXT,
    email TEXT NOT NULL,
    phone TEXT,
    mobile TEXT,
    wechat TEXT,
    whatsapp TEXT,
    is_primary BOOLEAN DEFAULT false,
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ leads Ë°®ÔºàÈîÄÂîÆÁ∫øÁ¥¢Ë°®Ôºâ
CREATE TABLE IF NOT EXISTS public.leads (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    lead_number TEXT NOT NULL UNIQUE,
    company_name TEXT NOT NULL,
    contact_name TEXT NOT NULL,
    email TEXT NOT NULL,
    phone TEXT,
    country TEXT NOT NULL,
    industry TEXT,
    source TEXT DEFAULT 'Other',
    status TEXT DEFAULT 'New',
    score INTEGER DEFAULT 0,
    notes TEXT,
    owner_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
    converted BOOLEAN DEFAULT false,
    converted_to_customer_id TEXT REFERENCES public.customers(id) ON DELETE SET NULL,
    converted_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ==================== Á¨¨‰∏âÈÉ®ÂàÜÔºö‰∫ßÂìÅÁÆ°ÁêÜ ====================

-- ÂàõÂª∫ product_categories Ë°®Ôºà‰∫ßÂìÅÂàÜÁ±ªË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.product_categories (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    name TEXT NOT NULL,
    name_cn TEXT,
    description TEXT,
    parent_id TEXT REFERENCES public.product_categories(id) ON DELETE SET NULL,
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ==================== Á¨¨‰∫îÈÉ®ÂàÜÔºöÈ°πÁõÆÁÆ°ÁêÜ ====================

-- ÂàõÂª∫ projects Ë°®ÔºàÈ°πÁõÆË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.projects (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    project_number TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    customer_id TEXT NOT NULL REFERENCES public.customers(id) ON DELETE RESTRICT,
    customer_name TEXT NOT NULL,
    type TEXT DEFAULT 'Standard',
    status TEXT DEFAULT 'Lead',
    stage TEXT DEFAULT 'Inquiry',
    priority TEXT DEFAULT 'Normal',
    incoterm TEXT DEFAULT 'FOB',
    port_of_loading TEXT,
    port_of_destination TEXT,
    currency TEXT DEFAULT 'USD',
    exchange_rate DECIMAL(10, 4) DEFAULT 1.0,
    estimated_value DECIMAL(15, 2) DEFAULT 0,
    probability INTEGER DEFAULT 0,
    tags TEXT[] DEFAULT '{}',
    notes TEXT,
    owner_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
    created_by UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
    expected_close_date TIMESTAMPTZ,
    closed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ==================== Á¨¨ÂõõÈÉ®ÂàÜÔºö‰æõÂ∫îÂïÜÁÆ°ÁêÜ ====================

-- ÂàõÂª∫ suppliers Ë°®Ôºà‰æõÂ∫îÂïÜË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.suppliers (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    supplier_number TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    name_cn TEXT,
    type TEXT DEFAULT 'Manufacturer',
    country TEXT NOT NULL,
    city TEXT,
    address TEXT,
    website TEXT,
    tax_id TEXT,
    rating INTEGER DEFAULT 0,
    payment_term TEXT DEFAULT 'T/T',
    currency TEXT DEFAULT 'CNY',
    primary_contact TEXT,
    email TEXT,
    phone TEXT,
    tags TEXT[] DEFAULT '{}',
    notes TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ supplier_contacts Ë°®Ôºà‰æõÂ∫îÂïÜËÅîÁ≥ª‰∫∫Ë°®Ôºâ
CREATE TABLE IF NOT EXISTS public.supplier_contacts (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    supplier_id TEXT NOT NULL REFERENCES public.suppliers(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    position TEXT,
    department TEXT,
    email TEXT NOT NULL,
    phone TEXT,
    mobile TEXT,
    wechat TEXT,
    whatsapp TEXT,
    is_primary BOOLEAN DEFAULT false,
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- =============== Ê≠§Â§ÑÁßªÂä®ÂàõÂª∫ products Ë°® ===============
-- ÂàõÂª∫ products Ë°®Ôºà‰∫ßÂìÅË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.products (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    sku TEXT NOT NULL UNIQUE,
    part_number TEXT,
    name TEXT NOT NULL,
    name_cn TEXT,
    description TEXT,
    description_cn TEXT,
    category_id TEXT REFERENCES public.product_categories(id) ON DELETE SET NULL,
    project_id TEXT REFERENCES public.projects(id) ON DELETE SET NULL,
    supplier_id TEXT REFERENCES public.suppliers(id) ON DELETE SET NULL,
    specs JSONB,
    unit TEXT DEFAULT 'pcs',
    moq INTEGER DEFAULT 1,
    price DECIMAL(15, 2),
    price_with_tax DECIMAL(15, 2),
    price_without_tax DECIMAL(15, 2),
    cost DECIMAL(15, 2),
    tax_refund_rate DECIMAL(5, 2),
    packaging_info TEXT,
    weight DECIMAL(15, 3),
    volume DECIMAL(15, 3),
    currency TEXT DEFAULT 'USD',
    images TEXT[] DEFAULT '{}',
    attachments TEXT[] DEFAULT '{}',
    hs_code TEXT,
    tags TEXT[] DEFAULT '{}',
    status TEXT DEFAULT 'Active',
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ==================== Á¨¨ÂÖ≠ÈÉ®ÂàÜÔºöÊä•‰ª∑ÁÆ°ÁêÜ ====================

-- ÂàõÂª∫ quotations Ë°®ÔºàÊä•‰ª∑Ë°®Ôºâ
CREATE TABLE IF NOT EXISTS public.quotations (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    quotation_number TEXT NOT NULL UNIQUE,
    project_id TEXT NOT NULL REFERENCES public.projects(id) ON DELETE RESTRICT,
    customer_id TEXT NOT NULL REFERENCES public.customers(id) ON DELETE RESTRICT,
    customer_name TEXT NOT NULL,
    version INTEGER DEFAULT 1,
    status TEXT DEFAULT 'Draft',
    currency TEXT DEFAULT 'USD',
    exchange_rate DECIMAL(10, 4) DEFAULT 1.0,
    incoterm TEXT DEFAULT 'FOB',
    port_of_loading TEXT,
    port_of_destination TEXT,
    shipping_method TEXT,
    payment_term TEXT DEFAULT 'T/T',
    validity_days INTEGER DEFAULT 30,
    delivery_days INTEGER DEFAULT 30,
    total_amount DECIMAL(15, 2) DEFAULT 0,
    discount DECIMAL(15, 2) DEFAULT 0,
    final_amount DECIMAL(15, 2) DEFAULT 0,
    notes TEXT,
    terms_and_conditions TEXT,
    prepared_by UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
    approved_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    approved_at TIMESTAMPTZ,
    sent_at TIMESTAMPTZ,
    expired_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ quotation_items Ë°®ÔºàÊä•‰ª∑È°πÁõÆË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.quotation_items (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    quotation_id TEXT NOT NULL REFERENCES public.quotations(id) ON DELETE CASCADE,
    product_id TEXT REFERENCES public.products(id) ON DELETE SET NULL,
    product_name TEXT NOT NULL,
    product_name_cn TEXT,
    description TEXT,
    specs JSONB,
    quantity INTEGER NOT NULL,
    unit TEXT DEFAULT 'pcs',
    unit_price DECIMAL(15, 2) NOT NULL,
    total_price DECIMAL(15, 2) NOT NULL,
    notes TEXT,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ==================== Á¨¨‰∏ÉÈÉ®ÂàÜÔºöËÆ¢ÂçïÁÆ°ÁêÜ ====================

-- ÂàõÂª∫ orders Ë°®ÔºàÈîÄÂîÆËÆ¢ÂçïË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.orders (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    order_number TEXT NOT NULL UNIQUE,
    project_id TEXT NOT NULL REFERENCES public.projects(id) ON DELETE RESTRICT,
    customer_id TEXT NOT NULL REFERENCES public.customers(id) ON DELETE RESTRICT,
    customer_name TEXT NOT NULL,
    quotation_id TEXT REFERENCES public.quotations(id) ON DELETE SET NULL,
    status TEXT DEFAULT 'Confirmed',
    currency TEXT DEFAULT 'USD',
    exchange_rate DECIMAL(10, 4) DEFAULT 1.0,
    incoterm TEXT DEFAULT 'FOB',
    port_of_loading TEXT,
    port_of_destination TEXT,
    shipping_method TEXT,
    payment_term TEXT DEFAULT 'T/T',
    total_amount DECIMAL(15, 2) NOT NULL,
    paid_amount DECIMAL(15, 2) DEFAULT 0,
    notes TEXT,
    created_by UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
    order_date TIMESTAMPTZ DEFAULT NOW(),
    expected_delivery_date TIMESTAMPTZ,
    actual_delivery_date TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ order_items Ë°®ÔºàËÆ¢ÂçïÈ°πÁõÆË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.order_items (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    order_id TEXT NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE,
    product_id TEXT REFERENCES public.products(id) ON DELETE SET NULL,
    product_name TEXT NOT NULL,
    description TEXT,
    quantity INTEGER NOT NULL,
    unit TEXT DEFAULT 'pcs',
    unit_price DECIMAL(15, 2) NOT NULL,
    total_price DECIMAL(15, 2) NOT NULL,
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ==================== Á¨¨ÂÖ´ÈÉ®ÂàÜÔºöÊ†∑ÂìÅÁÆ°ÁêÜ ====================

-- ÂàõÂª∫ samples Ë°®ÔºàÊ†∑ÂìÅË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.samples (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    sample_number TEXT NOT NULL UNIQUE,
    project_id TEXT NOT NULL REFERENCES public.projects(id) ON DELETE RESTRICT,
    product_id TEXT REFERENCES public.products(id) ON DELETE SET NULL,
    product_name TEXT NOT NULL,
    quantity INTEGER NOT NULL,
    unit TEXT DEFAULT 'pcs',
    status TEXT DEFAULT 'Requested',
    requested_by UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
    approved_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    supplier_id TEXT REFERENCES public.suppliers(id) ON DELETE SET NULL,
    cost DECIMAL(15, 2) DEFAULT 0,
    currency TEXT DEFAULT 'USD',
    notes TEXT,
    requested_at TIMESTAMPTZ DEFAULT NOW(),
    approved_at TIMESTAMPTZ,
    sent_at TIMESTAMPTZ,
    received_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ==================== Á¨¨‰πùÈÉ®ÂàÜÔºöÂèëÁ•®ÂíåÊîØ‰ªò ====================

-- ÂàõÂª∫ invoices Ë°®ÔºàÂèëÁ•®Ë°®Ôºâ
CREATE TABLE IF NOT EXISTS public.invoices (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    invoice_number TEXT NOT NULL UNIQUE,
    order_id TEXT NOT NULL REFERENCES public.orders(id) ON DELETE RESTRICT,
    customer_id TEXT NOT NULL REFERENCES public.customers(id) ON DELETE RESTRICT,
    customer_name TEXT NOT NULL,
    type TEXT DEFAULT 'Commercial',
    status TEXT DEFAULT 'Draft',
    currency TEXT DEFAULT 'USD',
    total_amount DECIMAL(15, 2) NOT NULL,
    paid_amount DECIMAL(15, 2) DEFAULT 0,
    tax_amount DECIMAL(15, 2) DEFAULT 0,
    notes TEXT,
    issued_by UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
    issue_date TIMESTAMPTZ DEFAULT NOW(),
    due_date TIMESTAMPTZ,
    paid_date TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ payments Ë°®ÔºàÊîØ‰ªòËÆ∞ÂΩïË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.payments (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    payment_number TEXT NOT NULL UNIQUE,
    type TEXT NOT NULL,
    related_type TEXT NOT NULL,
    related_id TEXT NOT NULL,
    amount DECIMAL(15, 2) NOT NULL,
    currency TEXT DEFAULT 'USD',
    exchange_rate DECIMAL(10, 4) DEFAULT 1.0,
    base_amount DECIMAL(15, 2) NOT NULL,
    base_currency TEXT DEFAULT 'CNY',
    method TEXT DEFAULT 'T/T',
    status TEXT DEFAULT 'Pending',
    reference_number TEXT,
    bank_name TEXT,
    account_number TEXT,
    notes TEXT,
    payer_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    recorded_by UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
    payment_date TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ==================== Á¨¨ÂçÅÈÉ®ÂàÜÔºöÈááË¥≠ËÆ¢Âçï ====================

-- ÂàõÂª∫ purchase_orders Ë°®ÔºàÈááË¥≠ËÆ¢ÂçïË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.purchase_orders (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    po_number TEXT NOT NULL UNIQUE,
    project_id TEXT REFERENCES public.projects(id) ON DELETE SET NULL,
    supplier_id TEXT NOT NULL REFERENCES public.suppliers(id) ON DELETE RESTRICT,
    supplier_name TEXT NOT NULL,
    status TEXT DEFAULT 'Draft',
    currency TEXT DEFAULT 'CNY',
    exchange_rate DECIMAL(10, 4) DEFAULT 1.0,
    total_amount DECIMAL(15, 2) NOT NULL,
    paid_amount DECIMAL(15, 2) DEFAULT 0,
    payment_term TEXT DEFAULT 'T/T',
    notes TEXT,
    created_by UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
    approved_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    order_date TIMESTAMPTZ DEFAULT NOW(),
    expected_delivery_date TIMESTAMPTZ,
    actual_delivery_date TIMESTAMPTZ,
    approved_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ purchase_order_items Ë°®ÔºàÈááË¥≠ËÆ¢ÂçïÈ°πÁõÆË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.purchase_order_items (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    po_id TEXT NOT NULL REFERENCES public.purchase_orders(id) ON DELETE CASCADE,
    product_id TEXT REFERENCES public.products(id) ON DELETE SET NULL,
    product_name TEXT NOT NULL,
    description TEXT,
    quantity INTEGER NOT NULL,
    unit TEXT DEFAULT 'pcs',
    unit_price DECIMAL(15, 2) NOT NULL,
    total_price DECIMAL(15, 2) NOT NULL,
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ==================== Á¨¨ÂçÅ‰∏ÄÈÉ®ÂàÜÔºöÂÆ°ÊâπÁ≥ªÁªü ====================

-- ÂàõÂª∫ approval_flows Ë°®ÔºàÂÆ°ÊâπÊµÅÁ®ãÈÖçÁΩÆË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.approval_flows (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    name TEXT NOT NULL,
    type TEXT NOT NULL,
    description TEXT,
    rules JSONB NOT NULL,
    levels JSONB NOT NULL,
    is_active BOOLEAN DEFAULT true,
    is_default BOOLEAN DEFAULT false,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ approvals Ë°®ÔºàÂÆ°ÊâπËÆ∞ÂΩïË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.approvals (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    approval_number TEXT NOT NULL UNIQUE,
    flow_id TEXT REFERENCES public.approval_flows(id) ON DELETE SET NULL,
    type TEXT NOT NULL,
    related_id TEXT NOT NULL,
    related_type TEXT NOT NULL,
    related_data JSONB,
    amount DECIMAL(15, 2),
    currency TEXT DEFAULT 'CNY',
    requester_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
    requester_name TEXT NOT NULL,
    request_reason TEXT,
    current_approver_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    current_level INTEGER DEFAULT 1,
    status TEXT DEFAULT 'Pending',
    priority TEXT DEFAULT 'Normal',
    comments TEXT,
    submitted_at TIMESTAMPTZ DEFAULT NOW(),
    approved_at TIMESTAMPTZ,
    rejected_at TIMESTAMPTZ,
    cancelled_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ approval_history Ë°®ÔºàÂÆ°ÊâπÂéÜÂè≤ËÆ∞ÂΩïË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.approval_history (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    approval_id TEXT NOT NULL REFERENCES public.approvals(id) ON DELETE CASCADE,
    level INTEGER NOT NULL,
    approver_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
    approver_name TEXT NOT NULL,
    action TEXT NOT NULL,
    comments TEXT,
    snapshot JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ==================== Á¨¨ÂçÅ‰∫åÈÉ®ÂàÜÔºöÈÄöÁü•Á≥ªÁªü ====================

-- ÂàõÂª∫ notifications Ë°®ÔºàÈÄöÁü•ËÆ∞ÂΩïË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.notifications (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    type TEXT NOT NULL,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    related_type TEXT,
    related_id TEXT,
    action_url TEXT,
    is_read BOOLEAN DEFAULT false,
    read_at TIMESTAMPTZ,
    approval_id TEXT REFERENCES public.approvals(id) ON DELETE SET NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ==================== Á¨¨ÂçÅ‰∏âÈÉ®ÂàÜÔºöÂ∑•‰ΩúÊµÅÁ≥ªÁªü ====================

-- ÂàõÂª∫ workflow_definitions Ë°®ÔºàÂ∑•‰ΩúÊµÅÂÆö‰πâË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.workflow_definitions (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    name TEXT NOT NULL,
    version TEXT DEFAULT '1.0',
    description TEXT,
    json_schema JSONB NOT NULL,
    nodes JSONB[] DEFAULT '{}',
    edges JSONB[] DEFAULT '{}',
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ workflow_instances Ë°®ÔºàÂ∑•‰ΩúÊµÅÂÆû‰æãË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.workflow_instances (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    definition_id TEXT NOT NULL REFERENCES public.workflow_definitions(id) ON DELETE RESTRICT,
    project_id TEXT NOT NULL REFERENCES public.projects(id) ON DELETE RESTRICT,
    status TEXT DEFAULT 'Active',
    current_context JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    completed_at TIMESTAMPTZ
);

-- ÂàõÂª∫ workflow_node_instances Ë°®ÔºàÂ∑•‰ΩúÊµÅËäÇÁÇπÂÆû‰æãË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.workflow_node_instances (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    instance_id TEXT NOT NULL REFERENCES public.workflow_instances(id) ON DELETE CASCADE,
    node_id TEXT NOT NULL,
    status TEXT DEFAULT 'Pending',
    assigned_to UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    completed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ workflow_actions Ë°®ÔºàÂ∑•‰ΩúÊµÅÊìç‰ΩúË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.workflow_actions (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    instance_id TEXT NOT NULL REFERENCES public.workflow_instances(id) ON DELETE CASCADE,
    node_id TEXT NOT NULL,
    action TEXT NOT NULL,
    performed_by UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
    payload JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ==================== Á¨¨ÂçÅÂõõÈÉ®ÂàÜÔºöÁâ©ÊµÅËØ¢‰ª∑ÂíåË¥πÁî® ====================

-- ÂàõÂª∫ logistics_inquiries Ë°®ÔºàÁâ©ÊµÅËØ¢‰ª∑ËÆ∞ÂΩïË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.logistics_inquiries (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    quotation_id TEXT NOT NULL REFERENCES public.quotations(id) ON DELETE CASCADE,
    inquiry_number TEXT NOT NULL UNIQUE,
    incoterm TEXT NOT NULL,
    port_of_loading TEXT,
    port_of_destination TEXT,
    shipping_method TEXT,
    total_weight DECIMAL(10, 2),
    total_volume DECIMAL(10, 3),
    package_count INTEGER,
    cargo_description TEXT,
    suppliers JSONB NOT NULL,
    template TEXT,
    status TEXT DEFAULT 'Draft',
    sent_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ logistics_quotes Ë°®ÔºàÁâ©ÊµÅÊúçÂä°ÂïÜÊä•‰ª∑Ë°®Ôºâ
CREATE TABLE IF NOT EXISTS public.logistics_quotes (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    inquiry_id TEXT NOT NULL REFERENCES public.logistics_inquiries(id) ON DELETE CASCADE,
    supplier_id TEXT REFERENCES public.suppliers(id) ON DELETE SET NULL,
    supplier_name TEXT NOT NULL,
    items JSONB NOT NULL,
    total_amount DECIMAL(15, 2) NOT NULL,
    currency TEXT DEFAULT 'CNY',
    valid_until TIMESTAMPTZ,
    is_selected BOOLEAN DEFAULT false,
    attachments TEXT[] DEFAULT '{}',
    notes TEXT,
    received_at TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ quotation_costs Ë°®ÔºàÊä•‰ª∑Ë¥πÁî®Ë°®Ôºâ
CREATE TABLE IF NOT EXISTS public.quotation_costs (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    quotation_id TEXT NOT NULL REFERENCES public.quotations(id) ON DELETE CASCADE,
    type TEXT NOT NULL,
    name TEXT NOT NULL,
    name_cn TEXT,
    amount DECIMAL(15, 2) DEFAULT 0,
    currency TEXT DEFAULT 'CNY',
    original_amount DECIMAL(15, 2),
    original_currency TEXT,
    exchange_rate DECIMAL(10, 4) DEFAULT 1.0,
    source TEXT DEFAULT 'manual',
    inquiry_id TEXT REFERENCES public.logistics_inquiries(id) ON DELETE SET NULL,
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ logistics_suppliers Ë°®ÔºàÁâ©ÊµÅÊúçÂä°ÂïÜË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.logistics_suppliers (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    name TEXT NOT NULL,
    type TEXT NOT NULL,
    contact TEXT,
    email TEXT,
    phone TEXT,
    services TEXT[] DEFAULT '{}',
    routes TEXT[] DEFAULT '{}',
    rating DECIMAL(3, 2) DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ==================== Á¨¨ÂçÅ‰∫îÈÉ®ÂàÜÔºöRFQ ÁÆ°ÁêÜ ====================

-- ÂàõÂª∫ rfq_records Ë°®ÔºàRFQÂèëÈÄÅËÆ∞ÂΩïË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.rfq_records (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    project_id TEXT NOT NULL REFERENCES public.projects(id) ON DELETE CASCADE,
    rfq_number TEXT NOT NULL UNIQUE,
    sent_by UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
    sent_at TIMESTAMPTZ DEFAULT NOW(),
    items JSONB NOT NULL,
    documents JSONB,
    currency TEXT DEFAULT 'USD',
    incoterm TEXT,
    port_of_loading TEXT,
    port_of_destination TEXT,
    status TEXT DEFAULT 'Sent',
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ rfq_supplier_records Ë°®ÔºàRFQ‰æõÂ∫îÂïÜËÆ∞ÂΩïË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.rfq_supplier_records (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    rfq_id TEXT NOT NULL REFERENCES public.rfq_records(id) ON DELETE CASCADE,
    supplier_id TEXT NOT NULL REFERENCES public.suppliers(id) ON DELETE RESTRICT,
    send_status TEXT DEFAULT 'Pending',
    send_error TEXT,
    sent_at TIMESTAMPTZ,
    reply_status TEXT DEFAULT 'NoReply',
    replied_at TIMESTAMPTZ,
    reply_content TEXT,
    reply_attachments JSONB,
    quotation JSONB,
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(rfq_id, supplier_id)
);

-- ==================== Á¨¨ÂçÅÂÖ≠ÈÉ®ÂàÜÔºöÈ°πÁõÆÊàêÊú¨ÂíåÂà©Ê∂¶ ====================

-- ÂàõÂª∫ project_costs Ë°®ÔºàÈ°πÁõÆÊàêÊú¨Ë°®Ôºâ
CREATE TABLE IF NOT EXISTS public.project_costs (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    project_id TEXT NOT NULL REFERENCES public.projects(id) ON DELETE CASCADE,
    type TEXT NOT NULL,
    amount DECIMAL(15, 2) NOT NULL,
    currency TEXT DEFAULT 'CNY',
    base_amount DECIMAL(15, 2) NOT NULL,
    base_currency TEXT DEFAULT 'CNY',
    exchange_rate DECIMAL(10, 4) DEFAULT 1.0,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ project_profit_reports Ë°®ÔºàÈ°πÁõÆÂà©Ê∂¶Êä•ÂëäË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.project_profit_reports (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    project_id TEXT NOT NULL REFERENCES public.projects(id) ON DELETE CASCADE,
    period TEXT NOT NULL,
    revenue DECIMAL(15, 2) NOT NULL,
    cost DECIMAL(15, 2) NOT NULL,
    gross_profit DECIMAL(15, 2) NOT NULL,
    margin DECIMAL(5, 2) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ project_profit_details Ë°®ÔºàÈ°πÁõÆÂà©Ê∂¶ËØ¶ÁªÜÊ†∏ÁÆóË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.project_profit_details (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    project_id TEXT NOT NULL REFERENCES public.projects(id) ON DELETE CASCADE,
    total_revenue DECIMAL(15, 2) DEFAULT 0,
    revenue JSONB NOT NULL,
    total_cost DECIMAL(15, 2) DEFAULT 0,
    costs JSONB NOT NULL,
    sample_cost DECIMAL(15, 2) DEFAULT 0,
    purchase_cost DECIMAL(15, 2) DEFAULT 0,
    shipping_cost DECIMAL(15, 2) DEFAULT 0,
    customs_cost DECIMAL(15, 2) DEFAULT 0,
    other_cost DECIMAL(15, 2) DEFAULT 0,
    gross_profit DECIMAL(15, 2) DEFAULT 0,
    net_profit DECIMAL(15, 2) DEFAULT 0,
    profit_margin DECIMAL(5, 2) DEFAULT 0,
    exchange_gain_loss DECIMAL(15, 2) DEFAULT 0,
    base_currency TEXT DEFAULT 'CNY',
    calculated_at TIMESTAMPTZ NOT NULL,
    calculated_by UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
    status TEXT DEFAULT 'Draft',
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ payment_reconciliations Ë°®ÔºàÊî∂‰ªòÊ¨æÊ†∏ÈîÄËÆ∞ÂΩïË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.payment_reconciliations (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    project_id TEXT NOT NULL REFERENCES public.projects(id) ON DELETE RESTRICT,
    payment_in_id TEXT REFERENCES public.payments(id) ON DELETE SET NULL,
    invoice_id TEXT REFERENCES public.invoices(id) ON DELETE SET NULL,
    payment_out_id TEXT REFERENCES public.payments(id) ON DELETE SET NULL,
    purchase_order_id TEXT REFERENCES public.purchase_orders(id) ON DELETE SET NULL,
    amount DECIMAL(15, 2) NOT NULL,
    currency TEXT DEFAULT 'CNY',
    status TEXT DEFAULT 'Reconciled',
    difference DECIMAL(15, 2) DEFAULT 0,
    difference_reason TEXT,
    reconciled_by UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
    reconciled_at TIMESTAMPTZ DEFAULT NOW(),
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ==================== Á¨¨ÂçÅ‰∏ÉÈÉ®ÂàÜÔºöÂºÇÂ∏∏Â§ÑÁêÜ ====================

-- ÂàõÂª∫ exceptions Ë°®ÔºàÂºÇÂ∏∏ËÆ∞ÂΩïË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.exceptions (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    exception_number TEXT NOT NULL UNIQUE,
    project_id TEXT NOT NULL REFERENCES public.projects(id) ON DELETE RESTRICT,
    type TEXT NOT NULL,
    severity TEXT DEFAULT 'Medium',
    source_type TEXT NOT NULL,
    source_id TEXT NOT NULL,
    title TEXT NOT NULL,
    description TEXT NOT NULL,
    responsible_party TEXT,
    status TEXT DEFAULT 'Open',
    assigned_to UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    solution TEXT,
    action_taken TEXT,
    impact JSONB,
    occurred_at TIMESTAMPTZ DEFAULT NOW(),
    resolved_at TIMESTAMPTZ,
    closed_at TIMESTAMPTZ,
    priority TEXT DEFAULT 'Normal',
    due_date TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ exception_history Ë°®ÔºàÂºÇÂ∏∏Â§ÑÁêÜÂéÜÂè≤Ë°®Ôºâ
CREATE TABLE IF NOT EXISTS public.exception_history (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    exception_id TEXT NOT NULL REFERENCES public.exceptions(id) ON DELETE CASCADE,
    action TEXT NOT NULL,
    from_value TEXT,
    to_value TEXT,
    performed_by UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
    comments TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ exception_reminders Ë°®ÔºàÂºÇÂ∏∏ÊèêÈÜíË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.exception_reminders (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    exception_id TEXT NOT NULL REFERENCES public.exceptions(id) ON DELETE CASCADE,
    remind_at TIMESTAMPTZ NOT NULL,
    remind_type TEXT NOT NULL,
    message TEXT NOT NULL,
    is_sent BOOLEAN DEFAULT false,
    sent_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ==================== Á¨¨ÂçÅÂÖ´ÈÉ®ÂàÜÔºöÂÖ∂‰ªñ‰∏öÂä°Ë°® ====================

-- ÂàõÂª∫ inspections Ë°®ÔºàË¥®Ê£ÄË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.inspections (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    po_id TEXT NOT NULL REFERENCES public.purchase_orders(id) ON DELETE RESTRICT,
    plan_date TIMESTAMPTZ NOT NULL,
    criteria TEXT NOT NULL,
    inspector_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
    status TEXT DEFAULT 'Scheduled',
    passed BOOLEAN,
    defects JSONB,
    attachments TEXT[] DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    completed_at TIMESTAMPTZ
);

-- ÂàõÂª∫ sample_costs Ë°®ÔºàÊ†∑ÂìÅÊàêÊú¨Ë°®Ôºâ
CREATE TABLE IF NOT EXISTS public.sample_costs (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    sample_id TEXT NOT NULL REFERENCES public.samples(id) ON DELETE CASCADE,
    type TEXT NOT NULL,
    amount DECIMAL(15, 2) NOT NULL,
    currency TEXT DEFAULT 'CNY',
    base_amount DECIMAL(15, 2) NOT NULL,
    base_currency TEXT DEFAULT 'CNY',
    exchange_rate DECIMAL(10, 4) DEFAULT 1.0,
    note TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ files Ë°®ÔºàÊñá‰ª∂Ë°®Ôºâ
CREATE TABLE IF NOT EXISTS public.files (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    name TEXT NOT NULL,
    path TEXT NOT NULL,
    size INTEGER NOT NULL,
    type TEXT NOT NULL,
    tags TEXT[] DEFAULT '{}',
    scope TEXT NOT NULL,
    ref_id TEXT,
    uploaded_by UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ÂàõÂª∫ templates Ë°®ÔºàÊ®°ÊùøË°®Ôºâ
CREATE TABLE IF NOT EXISTS public.templates (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    name TEXT NOT NULL,
    description TEXT,
    category TEXT,
    status TEXT DEFAULT 'Active',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

