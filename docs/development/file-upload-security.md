# 文件上传安全指南 / File Upload Security Guide

## ⚠️ 允许所有文件类型的风险

### 1. 安全风险

#### 恶意文件上传
- **可执行文件** (`.exe`, `.bat`, `.sh`, `.ps1`): 可能包含病毒、木马、恶意脚本
- **脚本文件** (`.js`, `.vbs`, `.php`): 如果被错误执行可能导致代码注入
- **宏文件** (`.docm`, `.xlsm`): Office 宏病毒
- **HTML/XML** (`.html`, `.htm`, `.xml`): 可能包含 XSS 攻击代码

#### 存储攻击
- **存储空间耗尽**: 恶意用户上传大量大文件耗尽存储配额
- **带宽消耗**: 大文件下载消耗大量带宽和成本
- **非法内容**: 可能被用于存储非法或有害内容

#### 合规风险
- **数据保护法规**: GDPR、数据安全法等要求严格控制文件类型
- **行业规范**: 某些行业（如金融、医疗）对文件类型有严格要求
- **审计要求**: 无法追踪和管理文件类型会增加审计风险

### 2. 性能风险

- **大文件处理**: 某些文件类型（如视频、3D模型）可能非常大
- **服务器负载**: 某些文件类型处理需要更多资源
- **传输时间**: 大文件上传下载时间过长影响用户体验

### 3. 运维风险

- **存储成本**: 无法控制存储的文件类型可能导致成本激增
- **备份复杂度**: 混合文件类型增加备份和恢复复杂度
- **内容管理**: 难以管理和组织不同类型的文件

## ✅ 推荐方案

### 方案 1: 扩展白名单（推荐）

支持常见的业务文件类型，但不包括危险类型：

```sql
-- 允许的文档和媒体类型
- 文档: PDF, Word, Excel, PowerPoint, RTF, TXT, CSV
- 压缩: ZIP, RAR, 7Z, GZIP, TAR
- 图片: PNG, JPEG, GIF, WebP, BMP, TIFF, SVG
- 视频: MP4, AVI, MOV, WMV (可选)
- 音频: MP3, WAV, OGG (可选)
```

### 方案 2: 完全开放（不推荐，仅内部系统）

仅在以下情况下考虑：
- 内部系统，所有用户都是可信的
- 有完整的文件扫描和病毒检测机制
- 有严格的访问控制和审计日志
- 有足够的存储和带宽预算

## 🛡️ 安全措施

### 1. 多层验证

#### 前端验证（用户体验）
- 文件类型检查
- 文件大小检查
- 文件扩展名检查

#### 后端验证（安全关键）
- MIME 类型验证（Supabase Storage）
- 文件大小限制（Supabase Storage）
- 文件内容扫描（可选）

### 2. 访问控制

- **私有存储桶**: 使用私有存储桶 + 签名 URL
- **RLS 策略**: 确保只有授权用户可以访问
- **审计日志**: 记录所有上传和下载操作

### 3. 文件扫描（高级）

- 病毒扫描: 集成 ClamAV 或其他扫描服务
- 内容检查: 检查文件内容是否符合预期类型
- 恶意代码检测: 检测脚本和可执行文件

## 📋 实施建议

### 当前配置（推荐）

```sql
-- documents 存储桶支持的文件类型
- 文档格式: PDF, Word, Excel, PowerPoint, RTF, TXT, CSV
- 压缩格式: ZIP, RAR, 7Z, GZIP, TAR
- 图片格式: PNG, JPEG, GIF, WebP
```

### 如果需要支持更多类型

1. **评估业务需求**: 确定真正需要的文件类型
2. **风险评估**: 评估新增类型的风险
3. **渐进式添加**: 先添加低风险类型，观察使用情况
4. **监控和审计**: 监控文件上传情况，定期审计

### 如果必须支持所有类型

1. **设置 allowed_mime_types = NULL**: 允许所有类型
2. **加强前端验证**: 在前端进行严格的文件类型检查
3. **实施文件扫描**: 集成病毒扫描服务
4. **加强访问控制**: 确保只有授权用户可以上传
5. **监控和告警**: 设置异常上传告警
6. **定期审计**: 定期检查和清理可疑文件

## 🔍 监控和告警

### 关键指标

- 上传文件数量和大小
- 文件类型分布
- 异常上传模式（如大量大文件）
- 存储使用情况

### 告警规则

- 单次上传文件超过阈值
- 短时间内大量上传
- 上传异常文件类型
- 存储空间使用率超过阈值

## 📚 参考资源

- [OWASP File Upload Security](https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload)
- [Supabase Storage Security](https://supabase.com/docs/guides/storage/security)
- [File Upload Best Practices](https://cheatsheetseries.owasp.org/cheatsheets/File_Upload_Cheat_Sheet.html)

